---
title: "Anonymous Work Part II."
author: "CoreyJackson"
date: "11/16/2018"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
#https://rmarkdown.rstudio.com/authoring_basics.html
# http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/ 
library(ggplot2)
library(plyr)
library(reshape2)
library(data.table)
library(readr)
library(knitr)
library(kableExtra)
library(gridExtra)
library(corrplot)
library(ggpubr)
library(sqldf)

```

```{r,  include=FALSE, warning=FALSE}
# import datasets 
geordi <- read_csv("~/Dropbox/INSPIRE/Data/System dumps/geordi-1-5-17.csv") # The raw geordi dataet
geordi_org <- read_csv("~/Dropbox/INSPIRE/Data/System dumps/geordi-1-5-17.csv") # The raw geordi dataet


# remove unnecessary columns 
geordi <- geordi[,-c(3,8,10:17,19)]

# First logged in as indicated by first classification with a username
joindate <- ddply(geordi,"userID",summarize,
                  firstclass = min(time[(which(new.category == "classify"))]))
joindate <- joindate[which(joindate$userID!="(anonymous)"),]

#
# Identifying anonymous events
#

# Find unique IP/user combinations
unique_combination <- unique(geordi[c("userID", "clientIP")])
unique_combination <- unique_combination[which(unique_combination$userID != "(anonymous)"),]

unique_ips <- ddply(unique_combination, c("clientIP"), summarise,
                    userids = length(unique(userID[which(userID != '(anonymous)')]))
                    )

# get IPs only associated with one user account
unique_ips <- unique_ips[which(unique_ips$userids == 1),]
# get their ids 
unique_ips <- merge(unique_ips, unique_combination, by ="clientIP",all.x = TRUE)

# create anon/non anon datasets
geordi_anonymous <- geordi[which(geordi$userID == "(anonymous)"),] # create dataset with only anonymous
geordi_nonanonymous <- geordi[which(geordi$userID != "(anonymous)"),]
remove(geordi)
geordi_anonymous <- merge(geordi_anonymous,unique_ips, by="clientIP", all.x=TRUE) # puts userIDs next to events associated with one userID

# rename/remove columns in both datasets
names(geordi_anonymous)[4]<-"userID" # rename columns
names(geordi_anonymous)[10]<-"userID_a"
geordi_anonymous <- geordi_anonymous[,-c(9)] # remove column
geordi_nonanonymous$userID_a <- geordi_nonanonymous$userID # adds userID to columns to make datasets the same length

geordi <- rbind(geordi_anonymous,geordi_nonanonymous) #Combine anon/non anon events
remove(geordi_anonymous,geordi_nonanonymous,unique_combination) # remove unnecessary dataframes

# concatenate events data
geordi$new.categories <- paste(geordi$type, geordi$relatedID, geordi$data, sep="-")

# get unique events to determine activity
# events <- unique(geordi[c("type","new.categories","breadcrumb")]) completed this step in previous analysis and manually labeled events
events <- read_csv("~/Dropbox/INSPIRE/Papers & Presentations/Anonymous Work (Journal)/events.csv")
# remove highlevel events not needed for analysis
events <- events[which(!is.na(events$new.category)),]
# merge names of events
geordi <- merge(geordi,events, by="new.categories", all.x=TRUE)

# create the original dataset

# Change experiment classificaions to classify
geordi$new.category[geordi$type.x %in% c("classificationStart")] <- "classify"

# Combine tutorials events 
geordi$new.category[geordi$new.category %in% c("tutorial - beginner 2","tutorial - beginner 1","tutorial - no training","tutorial - beginner 3","tutorial - apprentice","tutorial - master","tutorial")] <- "tutorial"

# Remove events
geordi <- geordi[which(!geordi$new.category %in% c("close-field-guide","register account","login","register account","link-post","logout","recent-comments-sidebar","view-talk","view-discussion","reply-post","paging")),]
# (talk-view) landing page for list of threads 
# (view-talk) viewing boards from project page. Only boards. Not sure if they clicked
# (view-discussion) viewing a single thread. Not sure where these views origniated. (use talk-N-view as proxy)


## Add meta-categories to dataset
geordi$meta[geordi$new.category %in% c("examine-image","image metadata","open-field-guide")] <- "task"
geordi$meta[geordi$new.category %in% c("talk-bugs-view","talk-chat-view", "talk-help-view",                                 
                                "talk-science-view","talk-notes-view","talk-view","talk-newglitches-view",
                                "talk-collections-view")] <- "viewing"
geordi$meta[geordi$new.category %in% c("post-comment","edit-post","delete-post","private-message",
                                       "update-comment","create-discussion")] <- "socialize"
geordi$meta[geordi$new.category %in% c("tutorial", "mini-course")] <- "learn"
geordi$meta[geordi$new.category %in% c( "view-profile-author","gs-about","gs-collections","view-profile-author"
                                        ,"gs-favorites","keyword search","hashtag-sidebar","view-member-profile")] <- "community"
geordi$meta[geordi$new.category %in% c("like-post", "unfavorite", "report-post","subscribe","click-favorite")] <- "impressions"
geordi$meta[geordi$new.category %in% c("classify")] <- "classification"

# remove events that weren't important
geordi <- geordi[which(!is.na(geordi$new.category)),]
remove(unique_ips,events)
```

## RQ1: Exploring the geordi dataset

#### Analysis: All anonymous events
```{r include=FALSE, warning=FALSE}

####################################### 
######## Datasets for analysis ######## 
#######################################

# All anonymous (linked and not linked)
geordi_all_anon <- geordi
# Anonymous traces we weren't able to link
geordi_anonymous_nolink <- geordi[which(is.na(geordi$userID_a)),] #117877 no link
# Anonymous traces we were able to link
geordi <- geordi[which(!is.na(geordi$userID_a)),] #2017383

####################################### 
####################################### 
#######################################

#### Visualize all anonymous activities
# activity summary 
geordi_visall <- ddply(subset(geordi_all_anon,userID =="(anonymous)"), c("meta","new.category"),summarize, 
                           users = length(unique(clientIP)),
                           activities = length(userID_a))

# simple bar plot 
m <- ggbarplot(subset(geordi_visall, !meta %in% c("classification","impressions","learn")), x = "new.category", y = "activities",
          fill = "meta",               # change fill color by cyl
          color = "white",            # Set bar border colors to white
          palette = "jco",            # jco journal color palett. see ?ggpar
          sort.val = "asc",           # Sort the value in dscending order
          sort.by.groups = TRUE,      # Sort inside each group
          x.text.angle = 90,
          ylab = "Event Count",xlab = "Event" # Rotate vertically x axis texts
          )
m <- m + font("xy.text", size = 9) 

# ggbarplot(subset(geordi_vislinked, !meta %in% c("classification","impressions","learn")), x = "new.category", y = "users",
#           fill = "meta",               # change fill color by cyl
#           color = "white",            # Set bar border colors to white
#           palette = "jco",            # jco journal color palett. see ?ggpar
#           sort.val = "asc",           # Sort the value in dscending order
#           sort.by.groups = TRUE,      # Sort inside each group
#           x.text.angle = 90           # Rotate vertically x axis texts
#           )

 #Complex line/point
# g <- ggdotchart(subset(geordi_visall, !meta %in% c("classification","impressions","learn")), x = "new.category", y = "activities",
#            color = "meta",                                # Color by groups
#            palette = "jco", # Custom color palette
#            sorting = "descending",                       # Sort value in descending order
#            add = "segments",                             # Add segments from y = 0 to dots
#            rotate = FALSE,                                # Rotate vertically
#            group = "meta",                                # Order by groups
#            dot.size = 6,                                 # Large dot size
#            label = "users",         # Add mpg values as dot labels
#            font.label = list(color = "white", size = 9, 
#                              vjust = 0.5),               # Adjust label parameters
#            ggtheme = theme_pubr(),                       # ggplot2 theme
#            ylab = "Event Count",xlab = "Event"
#            )
# 
# g <- g + font("xy.text", size = 9) 
```

```{r}
# all anonymous activities excluding classifications
ggpar(m, legend.title = "Meta-interaction")

```

#### Analysis: Anonymous events that we were able to link to a user account
```{r include=FALSE, warning=FALSE}

## Visualize all linked anonymous classifications
geordi_vislinked <- ddply(subset(geordi,userID =="(anonymous)"), c("meta","new.category"),summarize, 
                           users = length(unique(userID_a)),
                           activities = length(userID_a))

p <- ggdotchart(subset(geordi_vislinked, !meta %in% c("classification","impressions","learn")), x = "new.category", y = "activities",
           color = "meta",                                # Color by groups
           palette = "jco", # Custom color palette
           sorting = "descending",                       # Sort value in descending order
           add = "segments",                             # Add segments from y = 0 to dots
           rotate = FALSE,                                # Rotate vertically
           group = "meta",                                # Order by groups
           dot.size = 6,                                 # Large dot size
           label = "users",         # Add mpg values as dot labels
           font.label = list(color = "white", size = 9, 
                             vjust = 0.5),               # Adjust label parameters
           ggtheme = theme_pubr(),                       # ggplot2 theme
           ylab = "Event Count",xlab = "Event"
           )
p <- p + font("xy.text", size = 9) 

## Indication events before a user's first loggedin classification
geordi <- merge(geordi,joindate, by.y=("userID"), by.x=("userID_a"), all.x = TRUE)
geordi$preevent <- ifelse(geordi$time < geordi$firstclass,1,0) #1 if the record is before registering

# Contribution summary of all events in geordi
geordi_summary <- ddply(geordi, c("userID_a"), summarize, 
                        activities = length(userID_a),
                        anonymouscount = length(which(userID=="(anonymous)")), # all activities that were anon.
                        loggedincount = length(which(!userID=="(anonymous)")), # count activities that are not anon
                        first_classification = min(firstclass),
                        first_activitiy = min(time),
                        pre_reg_anon_activities = length(which(userID=="(anonymous)" & preevent ==1)),
                        post_reg_anon_activities = length(which(userID=="(anonymous)" & preevent ==0)),
                        classifications_future = length(userID_a[new.category=="classify" & preevent == 0]),
                        nonclassification_pre = length(userID_a[new.category != "classify" & preevent == 1])
                        )
geordi_summary$timepre <- geordi_summary$first_classification - geordi_summary$first_activitiy
# number will be diferent from 8606 above because some users don't actually classify. They create accounts and explore the system. 
```

```{r}
# Report out results from geordi analysis here
ggpar(p, legend.title = "Meta-interaction")

```

* __Descriptions of linked anonymous events__: 

#### Analysis: Anonymous sessions not linked to a user. 

All anonymous events for which we were able to link to a user account. There is another dataset that has `r length(geordi_anonymous_nolink$userID)` events that we weren't able to link to users.

```{r, include=FALSE, warning=FALSE}
# The anonymous activities use (geordi_anonymous_nolink) to do analysis on individual traces
# Export and run session info then reimport 
# setwd("~/Dropbox/INSPIRE/Papers & Presentations/Anonymous Work (Journal)/Data")
# write.csv(geordi_anonymous_nolink,"geordiIP_nolink.csv")
geordi_anonymous_nolink <- read_csv("~/Dropbox/INSPIRE/Papers & Presentations/Anonymous Work (Journal)/Data/geordiIP_nolinksession.csv") # The raw geordi dataet

# Summary by clientIP and session
geordi_summary_nolink <- ddply(geordi_anonymous_nolink, c("clientIP","Session"), summarize, 
                        activities = length(clientIP),
                        first_activity = min(time),
                        first_classification = min(time[meta == "classification"]),
                        first_nonclassactivitiy = min(time[meta != "classification"]),
                        last_activity = max(time),
                        task = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide"))),
                         viewing = length(which(new.category %in% c(
                           "talk-bugs-view","talk-chat-view", "talk-help-view", "talk-science-view","talk-notes-view",
                           "talk-view","talk-newglitches-view","talk-collections-view"))),
                         socialize = length(which(new.category %in% c(
                           "post-comment","edit-post","delete-post","private-message","update-comment"))),
                         learn = length(which(new.category %in% c("tutorial", "mini-course"))),
                          community = length(which(new.category %in% c(
                           "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites",
                           "keyword-search","hashtag-sidebar"))),
                          impressions = length(which(new.category %in% c(
                           "like-post", "unfavorite", "report-post","subscribe"))),
                          classifications = length(which(new.category %in% c("classify")))
                        )
geordi_summary_nolink$sessionlength <- geordi_summary_nolink$last_activity - geordi_summary_nolink$first_activity

# Create visualizations for meta-interactions
geordi_visnonlinked <- ddply(geordi_anonymous_nolink, c("meta","new.category"),summarize, 
                           users = length(unique(clientIP)),
                           activities = length(clientIP))

l <- ggdotchart(subset(geordi_visnonlinked, !meta %in% c("classification")), x = "new.category", y = "activities",
           color = "meta",                                # Color by groups
           palette = "jco", # Custom color palette
           sorting = "descending",                       # Sort value in descending order
           add = "segments",                             # Add segments from y = 0 to dots
           rotate = FALSE,                                # Rotate vertically
           group = "meta",                                # Order by groups
           dot.size = 8,                                 # Large dot size
           label = "users",         # Add mpg values as dot labels
           font.label = list(color = "white", size = 9, 
                             vjust = 0.5),               # Adjust label parameters
           ggtheme = theme_pubr(),                       # ggplot2 theme
           ylab = "Event Count",xlab = "Event"
           )
l <- l + font("xy.text", size = 9) 

```

```{r}
# Report out results from geordi_anonymous_nolink analysis here
ggpar(l, legend.title = "Meta-interaction")

```

* __Maintaining anonyomity__:Not logging in is a much greater phenomenon than previously thought. We can statistically determine whether first sessions are longer (more diverse) than those first sessions of volunteers who login. Appears to be advanced volunteers engaging in advanced work... e.g., liking posts.
 
#### Analysis: Users who never classified, but explored the system. What events did they execute? 

```{r include=FALSE, warning=FALSE}
nonclassusers <- joindate$userID[!(joindate$userID %in% geordi_summary$userID_a)] #304 not classifying...registered and explored
geordi_regnonclass <-  geordi_org[which(geordi_org$userID %in% nonclassusers),]
remove(nonclassusers)

#Use geordi_regnonclass to explore non-classifying volunteers. These data have some of the traces we weren't interested in examining.
```

* __Perpetual exploring__: The volunteers who only explored the system but never submitted a classification. 
```{r}
# Results
```

*****  

## Overview of pre and post registration anonymous events
```{r, include=FALSE, warning=FALSE}
# pre-reg and post-reg anon
baregister <- geordi[which(geordi$userID=="(anonymous)"),]
regsummary <- ddply(baregister, c("meta","preevent"), summarise,
                    count = length(new.category),
                    users = length(unique(userID_a))
)

### Pre-registration
prereganon <- baregister[which(baregister$preevent == 1),]
prereg_summary.meta <- ddply(prereganon, c("meta"), summarize,
                         users = length(unique(userID_a)),
                         prop_users = round(users/length(unique(prereganon$userID_a)),digits=4),
                         count = length(userID_a),
                         pro_count = round(count/dim(prereganon)[1],digits=4)
)

prereg_summary <- ddply(prereganon, c("meta","new.category"), summarize,
                         users = length(unique(userID_a)),
                         prop_users = round(users/length(unique(prereganon$userID_a)),digits=4),
                         count = length(userID_a),
                         prop_count = round(count/dim(prereganon)[1],digits=4)
)
q1.meta <- ggbarplot(subset(prereg_summary.meta, !meta %in% c("learn","classification")  ), 
                     x = "meta", y = "users",fill = "meta", color = "meta",xlab="Meta-Interaction",
                    palette = "jco", sorting = "descending",rotate = TRUE)
q1.meta <- q1.meta + font("xy.text", size = 9) 

q1 <- ggbarplot(subset(prereg_summary, !meta %in% c("learn","classification")), 
                x = "new.category", y = "users",fill = "meta", color = "meta",xlab="Event", 
                palette = "jco", sorting = "descending",rotate = TRUE)
q1 <- q1 + font("xy.text", size = 9) 

### Post-registration
postreganon <- baregister[which(baregister$preevent == 0),]
postreg_summary.meta <- ddply(postreganon, c("meta"), summarize,
                         users = length(unique(userID_a)),
                         prop_users = round(users/length(unique(postreganon$userID_a)),digits=4),
                         count = length(userID_a),
                         prop_count = round(count/dim(postreganon)[1],digits=4)
)

postreg_summary <- ddply(postreganon, c("meta","new.category"), summarize,
                         users = length(unique(userID_a)),
                         prop_users = round(users/length(unique(postreganon$userID_a)),digits=4),
                         count = length(userID_a),
                         prop_count = round(count/dim(postreganon)[1],digits=4)
)

q2.meta <- ggbarplot(subset(postreg_summary.meta, !meta %in% c("learn","classification")  ), 
                     x = "meta", y = "users",fill = "meta", color = "meta",xlab="Meta-Interaction",
                    palette = "jco", sorting = "descending",rotate = TRUE)
q2.meta <- q2.meta + font("xy.text", size = 9) 

q2 <- ggbarplot(subset(postreg_summary, !meta %in% c("learn","classification")  ), 
                x = "new.category", y = "users",fill = "meta", color = "meta",xlab="Event", 
                palette = "jco", sorting = "descending",rotate = TRUE)
q2 <- q2 + font("xy.text", size = 9) 

# Create visualizations fro pre-post

```

```{r}
# Other analysis for pre-registration (user level) and session

# Use dataset with session information.

## Event diversity

```

## RQ2 & RQ3: Pre/Post registration anonymous traces
```{r}
# Pre-registration
prereg_summary.meta
q1.meta
prereg_summary
q1
#remove(prereg_summary.meta,q1.meta,prereg_summary,q1)
```

* __Pre-registration traces__: Users typically did x before creating an account

* __Post-registration traces__: Users typically did x before loging-in with their account.

#### Analysis: How much time being anonymous 
```{r, include=FALSE, warning=FALSE}
geordi2 <- read_csv("~/Dropbox/INSPIRE/Papers & Presentations/Anonymous Work (Journal)/Data/Session/geordi-session-added.csv")
colnames(geordi2)[22] <- "Sequence"
geordi2[c(1,2,4,6,9,11:14,18:20)] <- NULL


geordi2anon <- geordi2[which(geordi2$userID == "(anonymous)"),]
geordi2anon$preevent <- as.factor(geordi2anon$preevent)

geordi2anon.summary <- ddply(geordi2anon, c("userID_a","Session","preevent"),summarize,
                                    activities = length(new.category),
                                    mintime = min(time),
                                    maxtime = max(time),
                                    timespent = as.numeric(difftime(maxtime,mintime, units = "mins"))
                                            )
geordi2anon.summary$timespent2 <- log(geordi2anon.summary$timespent)

aa <- ggdensity(subset(geordi2anon.summary,geordi2anon.summary$preevent =="1" & geordi2anon.summary$timespent >= 1),
   x = "timespent2",
   add = "mean", rug = TRUE,
    xlab = "Mins. to register (log)",
   color = "#E7B800", 
   fill = "#E7B800")
   #palette = c("#00AFBB", "#E7B800"))

```

* __Time to register: Parsing out those who contributed anonymously for a long period we see most register on the same day they began contributing. 

```{r}
mean(geordi2anon.summary$timespent[which(geordi2anon.summary$preevent =="1")])
sd(geordi2anon.summary$timespent[which(geordi2anon.summary$preevent =="1")])

aa


```

```{r, include=FALSE, warning=FALSE}
bb <- ggdensity(subset(geordi2anon.summary,geordi2anon.summary$preevent =="0" & geordi2anon.summary$timespent >= 1),
   x = "timespent2",
   add = "mean", rug = TRUE,
    xlab = "Mins. to login (log)",
   color = "#E7B800", 
   fill = "#E7B800")
   #palette = c("#00AFBB", "#E7B800"))

```

* __Time to signin: 
```{r}
bb

mean(geordi2anon.summary$timespent[which(geordi2anon.summary$preevent =="0")])
sd(geordi2anon.summary$timespent[which(geordi2anon.summary$preevent =="0")])

```


* __Diversity of pre-registration activities__: 
```{r}
# Post-registration
ggpar(q2.meta, legend.title = "Meta-interaction")
postreg_summary.meta

ggpar(q2, legend.title = "Meta-interaction")
postreg_summary


```
* __Post-registration traces__:

* __Time to signin__:

* __Diversity of pre-registration activities__: 

```{r include=FALSE, warning=FALSE}
#remove(anonymous_activities,anon_prepost)
remove(m,p,geordi_visall,geordi_vislinked,joindate)
```
`
***** 

## RQ4: Participation intention
```{r, include=FALSE, warning=FALSE}

# relationship between pre-registration and future contribution intention. Look at classification only, all, non-classifications

### NEED TO ADD OTHER TRACES EVEN THOUGH NOT IN PRE-REG.
geordi2_summary <- ddply(geordi2, c("userID_a","Session"), summarize,
                         task = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide") & userID != "(anonymous)")),
                         viewing = length(which(new.category %in% c(
                           "talk-bugs-view","talk-chat-view", "talk-help-view", "talk-science-view","talk-notes-view",
                           "talk-view","talk-newglitches-view","talk-collections-view")  
                            & userID != "(anonymous)")),
                         socialize = length(which(new.category %in% c(
                           "post-comment","edit-post","delete-post","private-message","update-comment")
                           & userID != "(anonymous)")),
                         learn = length(which(new.category %in% c(
                           "tutorial", "mini-course") & userID != "(anonymous)")),
                          community = length(which(new.category %in% c(
                           "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites",
                           "keyword-search","hashtag-sidebar")  
                           & userID != "(anonymous)")),
                          impressions = length(which(new.category %in% c(
                           "like-post", "unfavorite", "report-post","subscribe")  
                           & userID != "(anonymous)")),
                         classifications = length(which(new.category %in% c("classify")  
                                                        & userID != "(anonymous)")),
                          anontask = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide") 
                           & userID == "(anonymous)")),
                         anonviewing = length(which(new.category %in% c(
                           "talk-bugs-view","talk-chat-view", "talk-help-view", "talk-science-view","talk-notes-view",
                           "talk-view","talk-newglitches-view","talk-collections-view")  
                            & userID == "(anonymous)")),
                         anonsocialize = length(which(new.category %in% c(
                           "post-comment","edit-post","delete-post","private-message","update-comment")
                           & userID == "(anonymous)")),
                         anonlearn = length(which(new.category %in% c(
                           "tutorial", "mini-course") 
                           & userID == "(anonymous)")),
                          anoncommunity = length(which(new.category %in% c(
                           "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites",
                           "keyword-search","hashtag-sidebar")  
                           & userID == "(anonymous)")),
                         anonimpressions = length(which(new.category %in% c(
                           "like-post", "unfavorite", "report-post","subscribe")  
                           & userID == "(anonymous)")),
                         anonclassifications = length(which(new.category %in% c("classify") & userID == "(anonymous)")),
                         total_classifications = length(which(new.category %in% c("classify")))
                         )
geordi2_summary$totaltask <- geordi2_summary$task + geordi2_summary$anontask
geordi2_summary$totalview <- geordi2_summary$viewing + geordi2_summary$anonviewing
geordi2_summary$totalcommunity <- geordi2_summary$community + geordi2_summary$anoncommunity


geordi2_summary$anontype <- as.factor(ifelse(geordi2_summary$anonviewing > 0 | geordi2_summary$anonsocialize > 0 |
                                      geordi2_summary$anonlearn > 0 | geordi2_summary$anoncommunity > 0 |
                                      geordi2_summary$anonimpressions > 0 | geordi2_summary$anonclassifications > 0
                                      ,1,0))

geordi2_summary$anoninteraction <- geordi2_summary$anonviewing+geordi2_summary$anonsocialize+
                                 geordi2_summary$anonlearn+geordi2_summary$anoncommunity+
                                 geordi2_summary$anonimpressions

geordi2_summary$identifiedinteraction <- geordi2_summary$viewing+geordi2_summary$socialize+
                                 geordi2_summary$learn+geordi2_summary$community+
                                 geordi2_summary$impressions

geordi2_summary$totalinteraction <- geordi2_summary$identifiedinteraction + geordi2_summary$anoninteraction


geordi2_summary$tasktype <- as.factor(ifelse(geordi2_summary$anontask > 0 | geordi2_summary$task > 0,1,0))
geordi2_summary$viewingtype <- as.factor(ifelse(geordi2_summary$anonviewing > 0 | geordi2_summary$viewing > 0,1,0))
geordi2_summary$socialzingtype <- as.factor(ifelse(geordi2_summary$anonsocialize > 0 | geordi2_summary$socialize > 0,1,0))
geordi2_summary$learntype <- as.factor(ifelse(geordi2_summary$anonlearn > 0 | geordi2_summary$learn > 0,1,0))
geordi2_summary$communitytype <- as.factor(ifelse(geordi2_summary$anoncommunity > 0 | geordi2_summary$community > 0,1,0))
geordi2_summary$impressiontype <- as.factor(ifelse(geordi2_summary$anonimpressions > 0 | geordi2_summary$impressions > 0,1,0))
geordi2_summary$classifyingtype <- as.factor(ifelse(geordi2_summary$anonclassifications > 0 | geordi2_summary$classifications > 0,1,0))

# First session
geordi2_summary_first <- geordi2_summary[which(geordi2_summary$Session ==1),]
```

```{r, include=FALSE, warning=FALSE}
# Still around after session 1,2,3  by anonymous contributor status

anonuserlist <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==1)]
nonanonuserlist <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==0)]

tasklist.a <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==1 & geordi2_summary_first$tasktype == 1)]
tasklist.n <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==0 & geordi2_summary_first$tasktype == 1)]
community.a <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==1 & geordi2_summary_first$communitytype == 1)]
community.n <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==0 & geordi2_summary_first$communitytype == 1)]
view.a <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==1 & geordi2_summary_first$viewingtype == 1)]
view.n <- geordi2_summary_first$userID_a[which(geordi2_summary_first$anontype ==0 & geordi2_summary_first$viewingtype == 1)]

# Get activities of above users and summarize by session
geordi2_lateranon <- geordi2[which(geordi2$userID_a %in% anonuserlist & geordi2$Session >1),]
geordi2_laternonanon <- geordi2[which(geordi2$userID_a %in% nonanonuserlist & geordi2$Session >1),]

geordi2_summary_anon <- ddply(geordi2_lateranon, c("Session"), summarize,
                         users = length(unique(userID_a)),
                         proportion = users/length(anonuserlist),
                         task = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide"))),
                         viewing = length(which(new.category %in% c(
                           "talk-bugs-view","talk-chat-view", "talk-help-view", "talk-science-view","talk-notes-view",
                           "talk-view","talk-newglitches-view","talk-collections-view"))),
                         socialize = length(which(new.category %in% c(
                           "post-comment","edit-post","delete-post","private-message","update-comment"))),
                         learn = length(which(new.category %in% c("tutorial", "mini-course"))),
                          community = length(which(new.category %in% c(
                           "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites",
                           "keyword-search","hashtag-sidebar"))),
                          impressions = length(which(new.category %in% c(
                           "like-post", "unfavorite", "report-post","subscribe"))),
                         classifications = length(which(new.category %in% c("classify"))),
                          anontask = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide")))
                         )
geordi2_summary_anon$Anon.Type <- "AC"

geordi2_summary_nonanon <- ddply(geordi2_laternonanon, c("Session"), summarize,
                         users = length(unique(userID_a)),
                         proportion = users/length(nonanonuserlist),
                         task = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide"))),
                         viewing = length(which(new.category %in% c(
                           "talk-bugs-view","talk-chat-view", "talk-help-view", "talk-science-view","talk-notes-view",
                           "talk-view","talk-newglitches-view","talk-collections-view"))),
                         socialize = length(which(new.category %in% c(
                           "post-comment","edit-post","delete-post","private-message","update-comment"))),
                         learn = length(which(new.category %in% c("tutorial", "mini-course"))),
                          community = length(which(new.category %in% c(
                           "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites",
                           "keyword search","hashtag-sidebar"))),
                          impressions = length(which(new.category %in% c(
                           "like-post", "unfavorite", "report-post","subscribe"))),
                         classifications = length(which(new.category %in% c("classify"))),
                          anontask = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide")))
                         )
geordi2_summary_nonanon$Anon.Type <- "NAC"
geordi2_summary_future <- rbind(geordi2_summary_nonanon,geordi2_summary_anon)

### Get data by user
geordi2_user_summary_anon <- ddply(geordi2_lateranon, c("userID_a"), summarize,
                         tenure_begin = min(time),
                         tenure_end = max(time),
                          task = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide"))),
                         viewing = length(which(new.category %in% c(
                           "talk-bugs-view","talk-chat-view", "talk-help-view", "talk-science-view","talk-notes-view",
                           "talk-view","talk-newglitches-view","talk-collections-view"))),
                         socialize = length(which(new.category %in% c(
                           "post-comment","edit-post","delete-post","private-message","update-comment"))),
                         learn = length(which(new.category %in% c("tutorial", "mini-course"))),
                          community = length(which(new.category %in% c(
                           "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites",
                           "keyword search","hashtag-sidebar"))),
                          impressions = length(which(new.category %in% c(
                           "like-post", "unfavorite", "report-post","subscribe"))),
                         classifications = length(which(new.category %in% c("classify"))),
                          anontask = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide")))
                         )
geordi2_user_summary_anon$Anon.Type <- "AC"
geordi2_user_summary_anon$Task.Type <- ifelse(geordi2_user_summary_anon$userID_a %in% tasklist.a,"Task","No Task")
geordi2_user_summary_anon$Task.Type2 <- paste(geordi2_user_summary_anon$Anon.Type, geordi2_user_summary_anon$Task.Type, sep = "-")

geordi2_user_summary_anon$Community.Type <- ifelse(geordi2_user_summary_anon$userID_a %in% community.a,"Comm.","No Comm.")
geordi2_user_summary_anon$Community.Type2 <- paste(geordi2_user_summary_anon$Anon.Type, geordi2_user_summary_anon$Community.Type, sep = "-")

geordi2_user_summary_anon$Viewing.Type <-  ifelse(geordi2_user_summary_anon$userID_a %in% view.a,"View","No View")
geordi2_user_summary_anon$Viewing.Type2 <- paste(geordi2_user_summary_anon$Anon.Type, geordi2_user_summary_anon$Viewing.Type, sep = "-")

geordi2_user_summary_nonanon <- ddply(geordi2_laternonanon, c("userID_a"), summarize,
                        tenure_begin = min(time),
                         tenure_end = max(time),
                         task = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide"))),
                         viewing = length(which(new.category %in% c(
                           "talk-bugs-view","talk-chat-view", "talk-help-view", "talk-science-view","talk-notes-view",
                           "talk-view","talk-newglitches-view","talk-collections-view"))),
                         socialize = length(which(new.category %in% c(
                           "post-comment","edit-post","delete-post","private-message","update-comment"))),
                         learn = length(which(new.category %in% c("tutorial", "mini-course"))),
                          community = length(which(new.category %in% c(
                           "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites",
                           "keyword search","hashtag-sidebar"))),
                          impressions = length(which(new.category %in% c(
                           "like-post", "unfavorite", "report-post","subscribe"))),
                         classifications = length(which(new.category %in% c("classify"))),
                          anontask = length(which(new.category %in% c(
                           "examine-image","image metadata","open-field-guide")))
                         )

geordi2_user_summary_nonanon$Anon.Type <- "NAC"
geordi2_user_summary_nonanon$Task.Type <- ifelse(geordi2_user_summary_nonanon$userID_a %in% tasklist.n,"Task","No Task")
geordi2_user_summary_nonanon$Task.Type2 <- paste(geordi2_user_summary_nonanon$Anon.Type, geordi2_user_summary_nonanon$Task.Type,sep="-")

geordi2_user_summary_nonanon$Community.Type <- ifelse(geordi2_user_summary_nonanon$userID_a %in% community.n,"Comm.","No Comm.")
geordi2_user_summary_nonanon$Community.Type2 <- paste(geordi2_user_summary_nonanon$Anon.Type, geordi2_user_summary_nonanon$Community.Type,sep="-")

geordi2_user_summary_nonanon$Viewing.Type <-  ifelse(geordi2_user_summary_nonanon$userID_a %in% view.n,"View","No View")
geordi2_user_summary_nonanon$Viewing.Type2 <- paste(geordi2_user_summary_nonanon$Anon.Type, geordi2_user_summary_nonanon$Viewing.Type,sep="-")


geordi2_user_summary_future <- rbind(geordi2_user_summary_nonanon,geordi2_user_summary_anon)

#remove(geordi2_summary_nonanon,geordi2_laternonanon,nonanonuserlist,geordi2_summary_anon,geordi2_lateranon,anonuserlist,geordi2_user_summary_nonanon,geordi2_user_summary_anon)
```

#### Analysis: First session differences between anon/non-anon contributors
```{r }
# Still contributing after first session. Line represents those who contributed anonymously and non-anonymouly in first session
l<-ggline(subset(geordi2_summary_future, Session <= 15), x = "Session", y = "proportion", 
        #add = c("mean_se", "jitter"),
        ylab = "Proportion of Volunteers",
        color = "Anon.Type", palette = "jco")
ggpar(l, legend.title = "Contributor Type")
# Do anonymous first sessions differ in behaviors from registered sessions. What portion of volunteers do each of the activities. Is one activity associated with greater number of classifications
```

* __Portions of session contributions__: Similar proportions of volunteers who were anonymous/non-anonymous during their first sessionsstay around and contribute after their first session.

* __Different behaviors__: Our initial assumption is that the group of volunteers are inherently different from the population of volunteers who contribute registered from the beginning. We ask are there different variables that will determine whether anon/non-anon contributors differ. Analyzing their first session activities using 

#### Analysis: Do anonymous contributors differ from non-anon contributors in future participation 
```{r }
# boxplot of future classifications
geordi2_user_summary_future$classifications.log <- log(geordi2_user_summary_future$classifications)
geordi2_user_summary_future$classifications.log[geordi2_user_summary_future$classifications.log < 1] <- 0

my_comparisons <- list( c("Non-Anon Contributor", "Anon Contributor"))
z <- ggboxplot(geordi2_user_summary_future, x = "Anon.Type", y = "classifications",
            desc_stat = "mean", color = "Anon.Type", 
            ylab="Future Classifications(log)",xlab ="First Session Type",
            #add="dotplot", 
            palette = "jco",
            add.params = list(binwidth = 0.1, dotsize = 0.5)
            )+ 
  stat_compare_means(comparisons = my_comparisons)+ # Add pairwise comparisons p-value
  stat_compare_means(label.y = 20000) 

compare_means(classifications ~ Anon.Type,  data = geordi2_user_summary_future)
wilcox.test(classifications ~ Anon.Type,  data = geordi2_user_summary_future)
ggpar(z,legend = "none")


# Compare task
geordi2_user_summary_future$task.log <- log(geordi2_user_summary_future$task)
geordi2_user_summary_future$task.log[geordi2_user_summary_future$task.log < 1] <- 0

my_comparisons.task <- list(c("AC-Task","NAC-Task"),c("AC-No Task","NAC-No Task"))
a <- ggboxplot(geordi2_user_summary_future, x = "Task.Type2", y = "task",
            desc_stat = "mean_sd", color = "Anon.Type",
            #add="dotplot", 
            add = "jitter",
            palette = "jco", ylab = "Future Task Interactions",
            xlab = "Task Interactions in Session 1"
           # add.params = list(binwidth = 0.1, dotsize = 0.5)
           )

compare_means(task ~ Task.Type2,  data = geordi2_user_summary_future)
wilcox.test(task~Task.Type2, data = geordi2_user_summary_future,subset = Task.Type2 %in% c("AC-Task","NAC-Task"))  # 

a + stat_compare_means(comparisons = my_comparisons.task)+
  stat_compare_means(label.y = 10) + font("xy.text", size = 9) +
  rotate_x_text(45)

compare_means(classifications ~ Task.Type2,  data = geordi2_user_summary_future)


# Compare viewing
geordi2_user_summary_future$view.log <- log(geordi2_user_summary_future$viewing)
geordi2_user_summary_future$view.log[geordi2_user_summary_future$view.log < 1] <- 0

my_comparisons.viewing <- list(c("AC-No View","NAC-No View"),c("AC-View","NAC-View"))
p <- ggboxplot(geordi2_user_summary_future, x = "Viewing.Type2", y = "viewing",
            desc_stat = "mean_sd", color = "Anon.Type",
            #add="dotplot", 
            palette = "jco", ylab = "Future Viewing Interactions",
            xlab = "Viewing Interactions in Session 1",
                        add = "jitter"
            #add.params = list(binwidth = 0.1, dotsize = 0.9)
            )
compare_means(viewing ~ Viewing.Type2,  data = geordi2_user_summary_future)
compare_means(classifications ~ Viewing.Type2,  data = geordi2_user_summary_future)

p + stat_compare_means(comparisons = my_comparisons.viewing)+
  stat_compare_means(label.y = 9000) + font("xy.text", size = 9) +
  rotate_x_text(45)
           
# Compare community
geordi2_user_summary_future$community.log <- log(geordi2_user_summary_future$community)
geordi2_user_summary_future$community.log[geordi2_user_summary_future$community.log < 1] <- 0

my_comparisons.community <- list(c("AC-No Comm.","NAC-No Comm."),c("AC-Comm.","NAC-Comm."))
m <- ggboxplot(geordi2_user_summary_future, x = "Community.Type2", y = "community",
             desc_stat = "mean_sd", color = "Anon.Type",
            #add="dotplot", 
            add = "jitter",
            palette = "jco", ylab = "Future Community Interactions",
            xlab = "Community Interactions in Session 1"
            #add.params = list(binwidth = 0.1, dotsize = 0.9)
            )

compare_means(community ~ Community.Type2,  data = geordi2_user_summary_future)
compare_means(classifications ~ Community.Type2,  data = geordi2_user_summary_future)

m + stat_compare_means(comparisons = my_comparisons.community)+
  stat_compare_means(label.y = 1500) + font("xy.text", size = 9) +
  rotate_x_text(45)

```

* __Relationship to first session contributions and future contributions__:  


*****
## RQ5. Participation around signing in for known volunteers

#### Analysis: What users do immediately following logging-in/creating an account 
```{r, include=FALSE, warning=FALSE}
# Sessions after having an account
nextact <- ddply(geordi2, c("userID_a","Session"),summarize, 
                      maxseq = (max(Sequence[which(userID == "(anonymous)")])+1) # get the max seq. number of the anonymous activity and add 1 to get the number to get the next activity
                      )
nextact <- nextact[which(nextact$maxseq != Inf),]


nextactivity <- sqldf("select * from geordi2, nextact where geordi2.userID_a = nextact.userID_a and geordi2.Sequence = nextact.maxseq and geordi2.Session = nextact.Session") # Get the next activity having the same criteria as above and also belonging to the same session

nextactivity$meta[nextactivity$new.category %in% c("examine-image","image metadata","open-field-guide")] <- "task"
nextactivity$meta[nextactivity$new.category %in% c("talk-bugs-view","talk-chat-view", "talk-help-view",
                                "talk-science-view","talk-notes-view","talk-view","talk-newglitches-view",
                                "talk-collections-view")] <- "viewing"
nextactivity$meta[nextactivity$new.category %in% c("post-comment","edit-post","delete-post","private-message",
                                       "update-comment","create-discussion")] <- "socialize"
nextactivity$meta[nextactivity$new.category %in% c("tutorial", "mini-course")] <- "learn"
nextactivity$meta[nextactivity$new.category %in% c( 
                "view-profile-author","gs-about","gs-collections","view-profile-author","gs-favorites","keyword 
                search","hashtag-sidebar","view-member-profile")] <- "community"
nextactivity$meta[nextactivity$new.category %in% c("like-post", "unfavorite", "report-post","subscribe","click-favorite")] <- "impressions"
nextactivity$meta[nextactivity$new.category %in% c("classify")] <- "classification"

afterlogin <- ddply(nextactivity, c("meta","new.category"), summarize,
                         users = length(unique(userID_a)),
                         prop_users = round(users/length(unique(nextactivity$userID_a)),digits=4),
                         count = length(userID_a),
                         prop_count = round(count/dim(nextactivity)[1],digits=4)
)

q5 <- ggbarplot(subset(afterlogin,meta != "classification"), 
                     x = "new.category", y = "users",fill = "meta", color = "meta",xlab="Event",
                    palette = "jco", sorting = "descending",rotate = TRUE,sort.by.groups = TRUE)
q5<- q5 + font("xy.text", size = 9)

q5.meta <- ggbarplot(subset(afterlogin,meta != "classification"), 
                     x = "meta", y = "users",fill = "meta", color = "meta",xlab="Meta-Interaction",
                    palette = "jco",rotate = TRUE, sort.by.groups = TRUE)
q5.meta <- q5.meta + font("xy.text", size = 9)
remove(afterlogin,nextact)
```

```{r}

table(nextactivity$new.category)
ggpar(q5, legend.title = "Meta Type")

table(nextactivity$meta)
ggpar(q5.meta, legend.title = "Meta Type") 

```

* __After Logging In__: Most common activity is classifying (system prompt after 2 classifications when anonymous). 

        

